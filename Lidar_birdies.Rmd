---
title: "Lidar Birdies"
author: "Mike Allen"
date: "11/10/2020"
output: html_document
---

```{r}
library(raster)
library(rgdal)
library(sp)
library(sf)
library(tidyverse)
library(lidR)
library(tmap)
library(tmaptools)
library(lubridate)
library(unmarked)
```
# Read in shapefiles
```{r}
# read in duke field borders
duke <- 
   read_sf("data/duke_GL_pred_areas.shp") %>%
   st_transform(crs = 32618)
```
# Read in and check 2018 lidar files
Note: reprojected from NJ state plane (NAD83) into UTM zone 18 in LAStools in QGIS.
source for all lidR code used: http://www.wvview.org/spatial_analytics/lidar/_site/index.html#lidar
```{r}
# las_cat18 <- readLAScatalog("data/lidar2018/")
# projection(las_cat18) <- crs(6527) # state plane nad83(2011) in US feet
# summary(las_cat18)
# 
# lascheck(las_cat18)
```
# Read in and check 2008 lidar files
Note: reprojected from long/lat into UTM zone 18 in LAStools in QGIS.
source for code: http://www.wvview.org/spatial_analytics/lidar/_site/index.html#lidar
```{r}
#las_cat <- readLAScatalog("data/lidar2008/")
#projection(las_cat) <- crs(32618) # utm
#summary(las_cat)

#lascheck(las_cat)
```
# Choose scale to process 2018 lidar files
```{r}
# opt_chunk_size(las_cat18) <- 5100
# plot(las_cat18, chunk_pattern = TRUE)
# 
# opt_chunk_buffer(las_cat18) <- 100
# plot(las_cat18, chunk_pattern = TRUE)
```
# Choose scale to process 2008 lidar files
```{r}
#opt_chunk_size(las_cat) <- 2000
#plot(las_cat, chunk_pattern = TRUE)

#opt_chunk_buffer(las_cat) <- 40
#plot(las_cat, chunk_pattern = TRUE)
```
# View summary of 2018 lidar files
```{r}
# summary(las_cat18)
```
# View summary of 2008 lidar files
```{r}
#summary(las_cat)
```
# Create & view 2008 digital terrain models ("bare earth")
```{r}
# opt_output_files(las_cat) <- "data/dtm2008/dtm_{XLEFT}_{YBOTTOM}"
# dtm2008 <-
#    grid_terrain(las_cat,
#                 res = 1,
#                 knnidw(k = 10, p = 2),
#                 keep_lowest = FALSE) %>%
#    crop(y = (extent(duke) + c(-250, 250, -250, 250)))
# crs(dtm2008) <- crs(duke)

dtm2008 <- 
  raster("data/dtm2008.tif") # to save time

slope <- terrain(dtm2008, opt='slope')
aspect <- terrain(dtm2008, opt='aspect')
hs <- hillShade(slope, aspect, angle=45, direction=315)

tm_shape(hs)+
tm_raster(style= "cont", palette=get_brewer_pal("Greys", plot=FALSE))+
tm_layout(legend.outside = TRUE)
```
# Create & view 2018 digital terrain models ("bare earth")
```{r}
# opt_output_files(las_cat18) <- "data/dtm2018/dtm_{XLEFT}_{YBOTTOM}"
# dtm2018_step1 <-
#    grid_terrain(las_cat18,
#                 res = 3.28084,
#                 knnidw(k = 10, p = 2),
#                 keep_lowest = FALSE)
# 
# crs(dtm2018_step1) <-
#    CRS("+init=epsg:6527") # nj state plane nad83 (2011), grs80 in US feet
# 
# dtm2018 <-
#    projectRaster(from = dtm2018_step1,
#                  to = dtm2008) 
#
# dtm2018 <- dtm2018 / 3.28084

dtm2018 <-
   raster("data/dtm2018.tif") # to save time

slope <- terrain(dtm2018, opt='slope')
aspect <- terrain(dtm2018, opt='aspect')
hs <- hillShade(slope, aspect, angle=45, direction=315)

tm_shape(hs)+
tm_raster(style= "cont", palette=get_brewer_pal("Greys", plot=FALSE))+
tm_layout(legend.outside = TRUE)
```

# Create 2008 digital surface models (i.e., "bare earth + canopy height")
```{r}
# opt_output_files(las_cat) <- "data/dsm2008/dsm_{XLEFT}_{YBOTTOM}"
# dsm2008 <-
#    grid_canopy(las_cat, res = 1, pitfree(c(0, 2, 5, 10, 15), c(0, 1))) %>%
#    crop(extent(duke) + c(-250, 250, -250, 250))
# crs(dsm2008) <- crs(duke)

dsm2008 <- 
   raster("data/dsm2008.tif") # to save time

slope <- terrain(dsm2008, opt='slope')
aspect <- terrain(dsm2008, opt='aspect')
hs <- hillShade(slope, aspect, angle=45, direction=315)

tm_shape(hs)+
tm_raster(style= "cont", palette=get_brewer_pal("Greys", plot=FALSE))+
tm_layout(legend.outside = TRUE)
```
# Create 2018 digital surface models (i.e., "bare earth + canopy height")
```{r}
 # opt_output_files(las_cat18) <- "data/dsm2018/dsm_{XLEFT}_{YBOTTOM}"
 # dsm2018_step1 <-
 #    grid_canopy(las_cat18, res = 3.28084, pitfree(c(0, 2, 5, 10, 15), c(0, 1))) 
 # 
 # dsm2018_step1[dsm2018_step1>300] <- NA # remove elevation outliers
 # 
 # crs(dsm2018_step1) <-
 #    CRS("+init=epsg:6527") # nj state plane nad83 (2011), grs80 in US feet
 # 
 # dsm2018 <-
 #    projectRaster(from = dsm2018_step1,
 #                  to = dsm2008) 
 # 
 # dsm2018 <- dsm2018 / 3.28084
 
dsm2018 <- 
   raster("data/dsm2018.tif") # to save time

slope <- terrain(dsm2018, opt='slope')
aspect <- terrain(dsm2018, opt='aspect')
hs <- hillShade(slope, aspect, angle=45, direction=315)

tm_shape(hs)+
tm_raster(style= "cont", palette=get_brewer_pal("Greys", plot=FALSE))+
tm_layout(legend.outside = TRUE)
```
# Remove a tree line that was not present during the bird surveys
```{r}
# remove a tree line that was removed in 2018 after lidar but before survey
# make 4 boxes to "cut down" the tree line
boxes2018 = rbind.data.frame(
   expand.grid(
      y = c(7470:7610),
      x = c(8635:8681),
      new = 30.5
   ),
   expand.grid(
      y = c(7408:7465),
      x = c(8627:8661),
      new = 29.5
   ),
   expand.grid(
      y = c(7352:7410),
      x = c(8619:8649),
      new = 27.5
   ),
   expand.grid(
      y = c(7302:7354),
      x = c(8616:8646),
      new = 25.5
   )
) %>%
   group_by(y, x) %>%
   summarise(new = mean(new)) %>%
   ungroup() %>%
   mutate(y = format(y + 4480000.5, digits = 8),
          x = x + 520000.5)

dsm2018.newVals_step1 <- dsm2018
dsm2018.newVals_step1[is.na(dsm2018.newVals_step1)] <- 0
dsm2018.newVals <- rasterToPoints(dsm2018.newVals_step1) %>%
   as.data.frame(headers = F) %>%
   mutate(y = as.character(y)) %>%
   left_join(boxes2018, by = c("x", "y")) %>%
   mutate(dsm2018 = case_when(is.na(new) == T ~ dsm2018,
                              TRUE ~ new),
          y = as.numeric(y)) %>%
   dplyr::select(-new)

# make the new raster with treelines and artifacts removed
dsm2018.fix <- dsm2018 %>%
   setValues(dsm2018.newVals[,3])
# writeRaster(dsm2018.fix, "data/dsm2018.fix.tif", overwrite = T)
```
# Remove powerlines to test if occupancy model fits better with or without this
If without, then they are not likely reacting strongly to the wires
```{r}
boxes2018.nowires = rbind.data.frame(
   expand.grid(
      y = c(8799:8929),
      x = c(9301:9358),
      new = 3
   ),
   expand.grid(
      y = c(8619:8800),
      x = c(9292:9332),
      new = 3
   ),
   expand.grid(
      y = c(8438:8623),
      x = c(9282:9315),
      new = 3 
   ),
   expand.grid(
      y = c(8260:8442),
      x = c(9272:9309),
      new = 3
   ),
   expand.grid(
      y = c(8130:8263),
      x = c(9264:9296),
      new = 3
   ),
   expand.grid(
      y = c(7987:8132),
      x = c(9257:9286),
      new = 3
   ),
   expand.grid(
      y = c(7853:7992),
      x = c(9249:9282),
      new = 3 
   ),   
   expand.grid(
      y = c(7702:7861),
      x = c(9242:9314),
      new = 3 
   ),
   expand.grid(
      y = c(7684:7707),
      x = c(9276:9336),
      new = 3
   )
) %>%
   group_by(y, x) %>%
   summarise(new = mean(new)) %>%
   ungroup() %>%
   mutate(y = format(y + 4480000.5, digits = 8),
          x = x + 520000.5)

dsm2018.nowires.newVals <- rasterToPoints(dsm2018.fix) %>%
   as.data.frame(headers = F) %>%
   mutate(y = as.character(y)) %>%
   left_join(boxes2018.nowires, by = c("x", "y")) %>%
   mutate(dsm2018 = case_when(is.na(new) == T ~ dsm2018,
                              TRUE ~ new),
          y = as.numeric(y)) %>%
   dplyr::select(-new)

# make the new raster with treelines and artifacts removed
dsm2018.nowires <- dsm2018.fix %>%
   setValues(dsm2018.nowires.newVals[,3])
```
# Remove all tree lines for scenario evaluation
To see predicted effect on occupancy
```{r}
boxes2018.notrees = rbind.data.frame(
   expand.grid( # SW tree line
      y = c(7320:7676),
      x = c(8483:8677),
      new = 3
   ),
   expand.grid( # SE tree line
      y = c(7545:7682),
      x = c(8698:8853),
      new = 3
   ),
   expand.grid( # N tree line
      y = c(8356:8702),
      x = c(8642:8805),
      new = 3
   )
) %>%
   group_by(y, x) %>%
   summarise(new = mean(new)) %>%
   ungroup() %>%
   mutate(y = format(y + 4480000.5, digits = 8),
          x = x + 520000.5)

dsm2018.notrees.newVals <- rasterToPoints(dsm2018.fix) %>%
   as.data.frame(headers = F) %>%
   mutate(y = as.character(y)) %>%
   left_join(boxes2018.notrees, by = c("x", "y")) %>%
   mutate(dsm2018 = case_when(is.na(new) == T ~ dsm2018,
                              TRUE ~ new),
          y = as.numeric(y)) %>%
   dplyr::select(-new)

# make the new raster with treelines and artifacts removed
dsm2018.notrees <- dsm2018.fix %>%
   setValues(dsm2018.notrees.newVals[,3])
```
# Remove just the SW tree line for scenario evaluation
To see predicted effect on occupancy
```{r}
boxes2018.noSW = rbind.data.frame(
   expand.grid( # SW tree line
      y = c(7320:7676),
      x = c(8483:8677),
      new = 3
   )
) %>%
   group_by(y, x) %>%
   summarise(new = mean(new)) %>%
   ungroup() %>%
   mutate(y = format(y + 4480000.5, digits = 8),
          x = x + 520000.5)

dsm2018.noSW.newVals <- rasterToPoints(dsm2018.fix) %>%
   as.data.frame(headers = F) %>%
   mutate(y = as.character(y)) %>%
   left_join(boxes2018.noSW, by = c("x", "y")) %>%
   mutate(dsm2018 = case_when(is.na(new) == T ~ dsm2018,
                              TRUE ~ new),
          y = as.numeric(y)) %>%
   dplyr::select(-new)

# make the new raster with treelines and artifacts removed
dsm2018.noSW <- dsm2018.fix %>%
   setValues(dsm2018.noSW.newVals[,3])
```
# Remove just the SE tree line for scenario evaluation
To see predicted effect on occupancy
```{r}
boxes2018.noSE = rbind.data.frame(
   expand.grid( # SE tree line
      y = c(7545:7682),
      x = c(8698:8853),
      new = 3
   )
) %>%
   group_by(y, x) %>%
   summarise(new = mean(new)) %>%
   ungroup() %>%
   mutate(y = format(y + 4480000.5, digits = 8),
          x = x + 520000.5)

dsm2018.noSE.newVals <- rasterToPoints(dsm2018.fix) %>%
   as.data.frame(headers = F) %>%
   mutate(y = as.character(y)) %>%
   left_join(boxes2018.noSE, by = c("x", "y")) %>%
   mutate(dsm2018 = case_when(is.na(new) == T ~ dsm2018,
                              TRUE ~ new),
          y = as.numeric(y)) %>%
   dplyr::select(-new)

# make the new raster with treelines and artifacts removed
dsm2018.noSE <- dsm2018.fix %>%
   setValues(dsm2018.noSE.newVals[,3])
```
# Remove just the N tree line for scenario evaluation
To see predicted effect on occupancy
```{r}
boxes2018.noN = rbind.data.frame(
   expand.grid( # N tree line
      y = c(8356:8702),
      x = c(8642:8805),
      new = 3
   )
) %>%
   group_by(y, x) %>%
   summarise(new = mean(new)) %>%
   ungroup() %>%
   mutate(y = format(y + 4480000.5, digits = 8),
          x = x + 520000.5)

dsm2018.noN.newVals <- rasterToPoints(dsm2018.fix) %>%
   as.data.frame(headers = F) %>%
   mutate(y = as.character(y)) %>%
   left_join(boxes2018.noN, by = c("x", "y")) %>%
   mutate(dsm2018 = case_when(is.na(new) == T ~ dsm2018,
                              TRUE ~ new),
          y = as.numeric(y)) %>%
   dplyr::select(-new)

# make the new raster with treelines and artifacts removed
dsm2018.noN <- dsm2018.fix %>%
   setValues(dsm2018.noN.newVals[,3])
```

# Make the final rasters for horizon analysis
These are the corrected DSMs "flooded" to the height of the DTM plus 1.61 meters (human eye height).
```{r}
dtm2008_plus_eye <- dtm2008 + 1.61 # the height of Mike's eyes
dtm2018_plus_eye <- dtm2018 + 1.61 # the height of Mike's eyes

dsm.eye2008 <- max(dtm2008_plus_eye, dsm2008)
dsm.eye2018 <- max(dtm2018_plus_eye, dsm2018)
dsm.eye2018.fix <- max(dtm2018_plus_eye, dsm2018.fix)
dsm.eye2018.nowires <- max(dtm2018_plus_eye, dsm2018.nowires)
dsm.eye2018.notrees <- max(dtm2018_plus_eye, dsm2018.notrees)
dsm.eye2018.noSW <- max(dtm2018_plus_eye, dsm2018.noSW)
dsm.eye2018.noSE <- max(dtm2018_plus_eye, dsm2018.noSE)
dsm.eye2018.noN <- max(dtm2018_plus_eye, dsm2018.noN)

#writeRaster(dsm.eye2008, "data/dsm.eye2008.tif", overwrite = T)
#writeRaster(dsm.eye2018, "data/dsm.eye2018.tif", overwrite = T)
#writeRaster(dsm.eye2018.fix, "data/dsm.eye2018.fix.tif", overwrite = T)
#writeRaster(dsm.eye2018.nowires, "data/dsm.eye2018.nowires.tif", overwrite = T)
#writeRaster(dsm.eye2018.notrees, "data/dsm.eye2018.notrees.tif", overwrite = T)
#writeRaster(dsm.eye2018.noSW, "data/dsm.eye2018.noSW.tif", overwrite = T)
#writeRaster(dsm.eye2018.noSE, "data/dsm.eye2018.noSE.tif", overwrite = T)
#writeRaster(dsm.eye2018.noN, "data/dsm.eye2018.noN.tif", overwrite = T)
```

# Map mean horizon heights from all angles
Note: I used GRASS GUI (r.horizon & r.series functions) to make the horizon rasters. Mean or max of 72 height-of-horizon measurements around each cell.
```{r}
horizon2018_mean <- raster("data/big_files/horizon2018fix_mean_5.tif") 
horizon2018_max <- raster("data/big_files/horizon2018fix_max_5.tif") 

plot((90-mask(horizon2018_mean, duke)), col = viridis::inferno(256)); plot((90-mask(horizon2018_max, duke)), col = viridis::inferno(256))

```

# Formatting bird data for occupancy modelling
```{r}
d = read.csv("data/dukebirds2018-2019.QCed.2019-11-20.csv") %>%
   dplyr::select(
      obs,
      date,
      year,
      fld,
      per,
      pt,
      start,
      sp,
      num,
      dist,
      az,
      detect,
      sex,
      voc,
      lon = pt.lon,
      lat = pt.lat
   ) %>%
   st_as_sf(coords = c("lon", "lat"), crs = 4326) %>%
   st_transform(crs = crs(duke)) %>%
   mutate(r.date = mdy(date)) %>%
   mutate(ord = yday(r.date)) %>%
   mutate(month = month(r.date)) %>%
   mutate(
      dist3 = ifelse(sp == "GRSP" & is.na(dist) == T, 55, dist),
      dist4 = ifelse(sp == "BOBO" & is.na(dist) == T, 56, dist3),
      dist5 = ifelse(sp == "EAME" & is.na(dist) == T, 77, dist4),
      dist = ifelse(sp == "RWBL" & is.na(dist) == T, 57, dist5),
      az = ifelse(is.na(az) == T, runif(1, 0, 360), az)
   ) %>%
   select(-dist3,-dist4,-dist5) %>%
   mutate(
      hour = case_when(substr(start, 1, 1) == 1 ~ 10,
                       TRUE ~ as.numeric(substr(start, 1, 1))),
      min = case_when(substr(start, 1, 1) == 1 ~ 0,
                      TRUE ~ as.numeric(substr(start, 3, 4))),
      dtime = hour + min / 60
   )
#### NOTE RE MISSING DISTANCE DATA ####
# several GRSP and some other "hard to spot" species had dist and / or az left blank
# all of these records were believed to be within 100 m
# for mapping purposes, we will assume an average distance (by species) and random azimuth

pt.per.list <- d %>%
   as.data.frame() %>%
   dplyr::select(year, pt, per) %>%
   distinct() %>%
   arrange(year, pt, per)

d.occ.long <- d %>%
   as.data.frame() %>%
   mutate(pres = case_when(num>0 & dist<40 ~ 1,
                           TRUE ~ 0)) %>%
   dplyr::select(year, pt, per, sp, pres, ord, dtime) %>%
   group_by(year, pt, per, sp, ord, dtime) %>%
   summarise(pres = max(pres)) %>%
   ungroup()
   
g.occ <-
   d.occ.long %>%
   filter(sp == "GRSP") %>%
   right_join(pt.per.list, by = c("year", "pt", "per")) %>%
   mutate(pres = case_when(is.na(sp)==T ~ 0,
                           TRUE ~ pres)) %>%
   arrange(year, pt, per) %>%
   mutate(survey = case_when(per %in% c(1,2) ~ 1,
                             per %in% c(3,4) ~ 2, 
                             per %in% c(5,6) ~ 3,
                             per %in% c(7,8) ~ 4)) %>%
   pivot_wider(id = c(year, pt, survey), names_from = survey, values_from = pres) %>%
   mutate(site = case_when(substr(pt,1,1) == "K" ~ "K",
                           TRUE ~ "S"))

b.occ <-
   d.occ.long %>%
   filter(sp == "BOBO") %>%
   right_join(pt.per.list, by = c("year", "pt", "per")) %>%
   mutate(pres = case_when(is.na(sp)==T ~ 0,
                           TRUE ~ pres)) %>%
   arrange(year, pt, per) %>%
   mutate(survey = case_when(per %in% c(1,2) ~ 1,
                             per %in% c(3,4) ~ 2, 
                             per %in% c(5,6) ~ 3,
                             per %in% c(7,8) ~ 4)) %>%
   pivot_wider(id = c(year, pt, survey), names_from = survey, values_from = pres) %>%
   mutate(site = case_when(substr(pt,1,1) == "K" ~ "K",
                           TRUE ~ "S"))

e.occ <-
   d.occ.long %>%
   filter(sp == "EAME") %>%
   right_join(pt.per.list, by = c("year", "pt", "per")) %>%
   mutate(pres = case_when(is.na(sp)==T ~ 0,
                           TRUE ~ pres)) %>%
   arrange(year, pt, per) %>%
   mutate(survey = case_when(per %in% c(1,2) ~ 1,
                             per %in% c(3,4) ~ 2, 
                             per %in% c(5,6) ~ 3,
                             per %in% c(7,8) ~ 4)) %>%
   pivot_wider(id = c(year, pt, survey), names_from = survey, values_from = pres) %>%
   mutate(site = case_when(substr(pt,1,1) == "K" ~ "K",
                           TRUE ~ "S"))

survey.ord <-
   d.occ.long %>%
   distinct(year, pt, per, ord) %>%
   arrange(year, pt, per) %>%
   mutate(survey = case_when(per %in% c(1,2) ~ 1,
                             per %in% c(3,4) ~ 2, 
                             per %in% c(5,6) ~ 3,
                             per %in% c(7,8) ~ 4)) %>%
   pivot_wider(id = c(year, pt, survey), names_from = survey, values_from = ord) %>%
   mutate(site = case_when(substr(pt,1,1) == "K" ~ "K",
                           TRUE ~ "S"))

survey.dtime <-
   d.occ.long %>%
   distinct(year, pt, per, dtime) %>%
   arrange(year, pt, per) %>%
   mutate(dtime = case_when(is.na(dtime) ~ 7.7,
                            TRUE ~ as.numeric(dtime))) %>%
   mutate(survey = case_when(per %in% c(1,2) ~ 1,
                             per %in% c(3,4) ~ 2, 
                             per %in% c(5,6) ~ 3,
                             per %in% c(7,8) ~ 4)) %>%
   pivot_wider(id = c(year, pt, survey), names_from = survey, values_from = dtime) %>%
   mutate(site = case_when(substr(pt,1,1) == "K" ~ "K",
                           TRUE ~ "S"))
```

# Reaing in and formatting openness rasters for site-level covariates
```{r}
# function to create raster of circular moving window average of openness
mean.open = function(raster, 
                       radius) {
  # create the circular buffers (as matrices for the focal function)
  circles <- focalWeight(raster, radius, type = 'circle')
  circles[circles > 0] <- 1
  
  #raster[is.na(raster[])] <- 0
  
  mean.open.map = focal(
    raster,
    w = circles,
    fun = mean,
    pad = F,
    NAonly = F,
    na.rm = T
  )
  
  return(mean.open.map)
}

horizon2018_mean <-
   90 - raster("data/big_files/horizon2018fix_mean_5.tif")
horizon2018_mean_cov <-
    mean.open(mask(horizon2018_mean, duke), radius = 40) %>%
   mask(duke)
writeRaster(horizon2018_mean_cov,
             "data/big_files/horizon2018_mean_cov.tif",
             overwrite = T)
horizon2018_mean_cov <-
   raster("data/big_files/horizon2018_mean_cov.tif")

horizon2018_max <-
   90 - raster("data/big_files/horizon2018fix_max_5.tif")
horizon2018_max_cov <-
   mean.open(mask(horizon2018_max, duke), radius = 40) %>%
   mask(duke)
writeRaster(horizon2018_max_cov,
            "data/big_files/horizon2018_max_cov.tif",
            overwrite = T)
horizon2018_max_cov <-
   raster("data/big_files/horizon2018_max_cov.tif")

horizon2018_No_trees_mean <-
   90 - raster("data/big_files/horizon2018_No_trees_mean.tif")
horizon2018_No_trees_mean_cov <-
   mean.open(mask(horizon2018_No_trees_mean, duke), radius = 40) %>%
   mask(duke)
writeRaster(
   horizon2018_No_trees_mean_cov,
   "data/big_files/horizon2018_No_trees_mean_cov.tif",
   overwrite = T
)
horizon2018_No_trees_mean_cov <-
   raster("data/big_files/horizon2018_No_trees_mean_cov.tif")

horizon2018_No_trees_max <-
   90 - raster("data/big_files/horizon2018_No_trees_max.tif")
horizon2018_No_trees_max_cov <-
   mean.open(mask(horizon2018_No_trees_max, duke), radius = 40) %>%
   mask(duke)
writeRaster(
   horizon2018_No_trees_max_cov,
   "data/big_files/horizon2018_No_trees_max_cov.tif",
   overwrite = T
)
horizon2018_No_trees_max_cov <-
   raster("data/big_files/horizon2018_No_trees_max_cov.tif")

horizon2018_No_wires_mean <-
  90 - raster("data/big_files/horizon2018_No_wires_mean.tif")
horizon2018_No_wires_mean_cov <-
  mean.open(mask(horizon2018_No_wires_mean, duke), radius = 40) %>%
   mask(duke)
writeRaster(
  horizon2018_No_wires_mean_cov,
  "data/big_files/horizon2018_No_wires_mean_cov.tif",
  overwrite = T
)
horizon2018_No_wires_mean_cov <-
  raster("data/big_files/horizon2018_No_wires_mean_cov.tif")

horizon2018_No_wires_max <-
  90 - raster("data/big_files/horizon2018_No_wires_max.tif")
horizon2018_No_wires_max_cov <-
  mean.open(mask(horizon2018_No_wires_max, duke), radius = 40) %>%
   mask(duke)
writeRaster(
  horizon2018_No_wires_max_cov,
  "data/big_files/horizon2018_No_wires_max_cov.tif",
  overwrite = T
)
horizon2018_No_wires_max_cov <-
  raster("data/big_files/horizon2018_No_wires_max_cov.tif")

horizon2018_No_SW_mean <-
  90 - raster("data/big_files/horizon2018_No_SW_mean.tif")
horizon2018_No_SW_mean_cov <-
  mean.open(mask(horizon2018_No_SW_mean, duke), radius = 40) %>%
   mask(duke)
writeRaster(
  horizon2018_No_SW_mean_cov,
  "data/big_files/horizon2018_No_SW_mean_cov.tif",
  overwrite = T
)
horizon2018_No_SW_mean_cov <-
  raster("data/big_files/horizon2018_No_SW_mean_cov.tif")

horizon2018_No_SW_max <-
  90 - raster("data/big_files/horizon2018_No_SW_max.tif")
horizon2018_No_SW_max_cov <-
  mean.open(mask(horizon2018_No_SW_max, duke), radius = 40) %>%
   mask(duke)
writeRaster(
  horizon2018_No_SW_max_cov,
  "data/big_files/horizon2018_No_SW_max_cov.tif",
  overwrite = T
)
horizon2018_No_SW_max_cov <-
  raster("data/big_files/horizon2018_No_SW_max_cov.tif")

horizon2018_No_SE_mean <-
  90 - raster("data/big_files/horizon2018_No_SE_mean.tif")
horizon2018_No_SE_mean_cov <-
  mean.open(mask(horizon2018_No_SE_mean, duke), radius = 40) %>%
   mask(duke)
writeRaster(
  horizon2018_No_SE_mean_cov,
  "data/big_files/horizon2018_No_SE_mean_cov.tif",
  overwrite = T
)
horizon2018_No_SE_mean_cov <-
  raster("data/big_files/horizon2018_No_SE_mean_cov.tif")

horizon2018_No_SE_max <-
  90 - raster("data/big_files/horizon2018_No_SE_max.tif")
horizon2018_No_SE_max_cov <-
  mean.open(mask(horizon2018_No_SE_max, duke), radius = 40) %>%
   mask(duke)
writeRaster(
  horizon2018_No_SE_max_cov,
  "data/big_files/horizon2018_No_SE_max_cov.tif",
  overwrite = T
)
horizon2018_No_SE_max_cov <-
  raster("data/big_files/horizon2018_No_SE_max_cov.tif")

horizon2018_No_N_mean <-
  90 - raster("data/big_files/horizon2018_No_N3_mean.tif")
horizon2018_No_N_mean_cov <-
  mean.open(mask(horizon2018_No_N_mean, duke), radius = 40) %>%
   mask(duke)
writeRaster(
  horizon2018_No_N_mean_cov,
  "data/big_files/horizon2018_No_N_mean_cov.tif",
  overwrite = T
)
horizon2018_No_N_mean_cov <-
  raster("data/big_files/horizon2018_No_N_mean_cov.tif")

horizon2018_No_N_max <-
  90 - raster("data/big_files/horizon2018_No_N3_max.tif")
horizon2018_No_N_max_cov <-
  mean.open(mask(horizon2018_No_N_max, duke), radius = 40) %>%
   mask(duke)
writeRaster(
  horizon2018_No_N_max_cov,
  "data/big_files/horizon2018_No_N_max_cov.tif",
  overwrite = T
)
horizon2018_No_N_max_cov <-
  raster("data/big_files/horizon2018_No_N_max_cov.tif")

d.extract <- d %>% 
   dplyr::select(pt) %>%
   distinct(pt) 

site.cov <- cbind.data.frame(pt = as.data.frame(d.extract)$pt, 
           mean2018 = raster::extract(horizon2018_mean_cov, d.extract),
           max2018 = raster::extract(horizon2018_max_cov, d.extract),
           No_trees_mean = raster::extract(horizon2018_No_trees_mean_cov, d.extract),
           No_trees_max = raster::extract(horizon2018_No_trees_max_cov, d.extract),
           No_wires_mean = raster::extract(horizon2018_No_wires_mean_cov, d.extract),
           No_wires_max = raster::extract(horizon2018_No_wires_max_cov, d.extract),
           No_SW_mean = raster::extract(horizon2018_No_SW_mean_cov, d.extract),
           No_SW_max = raster::extract(horizon2018_No_SW_max_cov, d.extract),
           No_SE_mean = raster::extract(horizon2018_No_SE_mean_cov, d.extract),
           No_SE_max = raster::extract(horizon2018_No_SE_max_cov, d.extract),
           No_N_mean = raster::extract(horizon2018_No_N_mean_cov, d.extract),
           No_N_max = raster::extract(horizon2018_No_N_max_cov, d.extract)) %>%
   left_join(g.occ, by = "pt") %>%
   arrange(year, pt) %>%
   dplyr::select(year, pt, mean2018, max2018, No_trees_mean, No_trees_max, No_wires_mean, No_wires_max,No_SW_mean, No_SW_max,No_SE_mean, No_SE_max,No_N_mean, No_N_max, site)
```
# Create unmarked data.frame for GRSP, static occupancy, 2018 (unmarked)
```{r}
g.umf <- unmarkedFrameOccu(
   y = as.matrix(filter(g.occ, year == "year 1")[, 3:6]),
   # Pres/Abs measurements
   siteCovs = filter(site.cov, year == "year 1"),
   # site-specific covs.
   obsCovs = list(ord = (as.matrix(filter(
      survey.ord, year == "year 1"
   )[, 3:6]))/10, dtime = (as.matrix(filter(
      survey.dtime, year == "year 1"
   )[, 3:6])))
)         # obs-specific covs.
summary(g.umf)

g.umf.K18 <- unmarkedFrameOccu(
   y = as.matrix(filter(g.occ, site == "K", year == "year 1")[, 3:6]),
   # Pres/Abs measurements
   siteCovs = filter(site.cov, site == "K", year == "year 1"),
   # site-specific covs.
   obsCovs = list(ord = (as.matrix(filter(
      survey.ord, site == "K", year == "year 1"
   )[, 3:6]))/10, dtime = (as.matrix(filter(
      survey.dtime, site == "K", year == "year 1"
   )[, 3:6])))
)         # obs-specific covs.
summary(g.umf.K18)

g.umf.S18 <- unmarkedFrameOccu(
   y = as.matrix(filter(g.occ, site == "S", year == "year 1")[, 3:6]),
   # Pres/Abs measurements
   siteCovs = filter(site.cov, site == "S", year == "year 1"),
   # site-specific covs.
   obsCovs = list(ord = (as.matrix(filter(
      survey.ord, site == "S", year == "year 1"
   )[, 3:6]))/10, dtime = (as.matrix(filter(
      survey.dtime, site == "S", year == "year 1"
   )[, 3:6])))
)         # obs-specific covs.
summary(g.umf.S18)
```
# Select best detection model using AIC - Grasshopper Sparrow
Data from both sites.
```{r}
  p.ord_psi. <-
    occu(
      ~ ord ~ 1,
      data = g.umf
    )

  p.ord2_psi. <-
    occu(
      ~ ord + I(ord)^2 ~ 1,
      data = g.umf
    )

  p.dtime_psi. <-
    occu(
      ~ dtime ~ 1,
      data = g.umf
    )

  p.dtime2_psi. <-
    occu(
      ~ dtime + I(dtime)^2 ~ 1,
      data = g.umf,
      starts = c(2, 2, 2, 2)
    )
  
    p.ord.dtime_psi. <-
    occu(
      ~ ord + dtime ~ 1,
      data = g.umf
    )

  p.ord.dtime2_psi. <-
    occu(
      ~ ord + dtime + I(dtime)^2 ~ 1,
      data = g.umf,
      starts = c(-2, -2, -2, 2, 2)
    )
  
  p.ord2.dtime_psi. <-
    occu(
      ~ ord + I(ord)^2 + dtime ~ 1,
      data = g.umf
    )
    
  p.ord2.dtime2_psi. <-
    occu(
      ~ ord + I(ord)^2 + dtime + I(dtime)^2 ~ 1,
      data = g.umf,
      starts = c(-2, -2, -2, -2, 2, 2)
    )
  
  AICcmodavg::aictab(
    list(
      p.ord_psi. = p.ord_psi.,
      p.ord2_psi. = p.ord2_psi.,
      p.dtime_psi. = p.dtime_psi.,
      p.dtime2_psi. = p.dtime2_psi.,
      p.ord.dtime_psi. = p.ord.dtime_psi.,
      p.ord2.dtime_psi. = p.ord2.dtime_psi.,
      p.ord2.dtime2_psi. = p.ord2.dtime2_psi.
      )
  )

AICcmodavg::modavg(list(p.ord_psi., p.dtime_psi., p.ord.dtime_psi.), parm = "dtime", parm.type = "detect")

AICcmodavg::modavg(list(p.ord_psi., p.dtime_psi., p.ord.dtime_psi.), parm = "ord", parm.type = "detect")

summary(p.ord_psi.)
summary(p.dtime_psi.)
summary(p.ord.dtime_psi.)

# Model selection based on AICc:
# 
#                    K   AICc Delta_AICc AICcWt Cum.Wt      LL
# p.ord_psi.         3 792.84       0.00   0.28   0.28 -393.37
# p.dtime_psi.       3 793.16       0.32   0.24   0.51 -393.53
# p.ord.dtime_psi.   4 793.43       0.58   0.21   0.72 -392.63
# p.ord2_psi.        4 794.91       2.07   0.10   0.82 -393.37
# p.dtime2_psi.      4 795.23       2.38   0.08   0.90 -393.53
# p.ord2.dtime_psi.  5 795.51       2.67   0.07   0.97 -392.63
# p.ord2.dtime2_psi. 6 797.62       4.77   0.03   1.00 -392.63

```
# Both - wires vs. no wires, Evaluate mean vs. max openness models
```{r}
    p.ord.dtime_psi. <-
    occu(
      ~ ord + dtime ~ site,
      data = g.umf
    )

    p.ord.dtime_psi.mean <-
    occu(
      ~ ord + dtime ~ site + mean2018,
      data = g.umf
    )

    p.ord.dtime_psi.max <-
    occu(
      ~ ord + dtime ~ site + max2018,
      data = g.umf
    )
    
    p.ord.dtime_psi.No_wires_mean <-
    occu(
      ~ ord + dtime ~ site + No_wires_mean,
      data = g.umf
    )

    p.ord.dtime_psi.No_wires_max <-
    occu(
      ~ ord + dtime ~ site + No_wires_max,
      data = g.umf
    )

  AICcmodavg::aictab(
    list(
      p.ord.dtime_psi. = p.ord.dtime_psi.,
      p.ord.dtime_psi.mean = p.ord.dtime_psi.mean,
      p.ord.dtime_psi.max = p.ord.dtime_psi.max,
      p.ord.dtime_psi.No_wires_mean = p.ord.dtime_psi.No_wires_mean,
      p.ord.dtime_psi.No_wires_max = p.ord.dtime_psi.No_wires_max
      )
  )    

# Model selection based on AICc:
# 
#                               K   AICc Delta_AICc AICcWt Cum.Wt      LL
# p.ord.dtime_psi.max           6 740.93       0.00   0.74   0.74 -364.28
# p.ord.dtime_psi.No_wires_max  6 743.26       2.33   0.23   0.97 -365.45
# p.ord.dtime_psi.mean          6 747.22       6.29   0.03   1.00 -367.43
# p.ord.dtime_psi.No_wires_mean 6 753.83      12.90   0.00   1.00 -370.73
# p.ord.dtime_psi.              5 762.17      21.24   0.00   1.00 -375.96
```
# Grasshopper sparrow: Graph relationship with max 
```{r}
plotdata = data.frame(
   predict(
      p.ord.dtime_psi.max,
      newdata = data.frame(max2018 = rep(seq(
         12.9, 66.6, length.out = 100
      ), 2), site = c(rep("K", 100), rep("S", 100))),
      type = "state"
   ),
   data.frame(max2018 = rep(seq(
      12.9, 66.6, length.out = 100
   ), 2), site = c(rep("K", 100), rep("S", 100)))
)

ggplot(plotdata) +
   geom_ribbon(aes(
      x = max2018,
      ymin = lower * 100,
      ymax = upper * 100,
      fill = site
   ),
   alpha = 0.5) +
   geom_line(aes(x = max2018, y = Predicted * 100, fill = site), size = 1.5) +
   scale_fill_manual(values = c("firebrick", "steelblue")) +
   theme_bw() +
   theme(axis.text = element_text(size = 14),
         axis.title = element_text(size = 14)) +
   labs(x = "Openness index (90 - max degrees to horizon)", y = "Grasshopper Sparrow Occupancy (%)", fill = "Site")
#ggsave("figures/Fig_2_relationship_max_openness.jpg", height = 5, width = 7, dpi = 600)
```
#Predicted occupancy in various openness scenarios
Page 599-600 in AHM 1 (Kery) shows how to get bootstrapped CIs for this number
```{r}

# No action (2018 conditions)
no_action_pred_cov <- raster::extract(horizon2018_max_cov, d.extract)

pred_no_action = data.frame(
   predict(
      p.ord.dtime_psi.max,
      newdata = data.frame(max2018 = no_action_pred_cov, site = c(rep("K", 59), rep("S", 59), rep("K", 60), rep("S", 60))),
      type = "state"
   ),
   data.frame(max2018 = no_action_pred_cov, site = c(rep("K", 59), rep("S", 59), rep("K", 60), rep("S", 60)))
)

# scenario with all 3 Kaufman tree lines removed
no_trees_pred_cov <- raster::extract(horizon2018_No_trees_max_cov, d.extract)

pred_no_trees = data.frame(
   predict(
      p.ord.dtime_psi.max,
      newdata = data.frame(max2018 = no_trees_pred_cov, site = c(rep("K", 59), rep("S", 59), rep("K", 60), rep("S", 60))),
      type = "state"
   ),
   data.frame(max2018 = no_trees_pred_cov, site = c(rep("K", 59), rep("S", 59), rep("K", 60), rep("S", 60)))
)

# scenario with just SW Kaufman tree line removed
no_SW_pred_cov <- raster::extract(horizon2018_No_SW_max_cov, d.extract)

pred_no_SW = data.frame(
   predict(
      p.ord.dtime_psi.max,
      newdata = data.frame(max2018 = no_SW_pred_cov, site = c(rep("K", 59), rep("S", 59), rep("K", 60), rep("S", 60))),
      type = "state"
   ),
   data.frame(max2018 = no_SW_pred_cov, site = c(rep("K", 59), rep("S", 59), rep("K", 60), rep("S", 60)))
)

# scenario with just SE Kaufman tree line removed
no_SE_pred_cov <- raster::extract(horizon2018_No_SE_max_cov, d.extract)

pred_no_SE = data.frame(
   predict(
      p.ord.dtime_psi.max,
      newdata = data.frame(max2018 = no_SE_pred_cov, site = c(rep("K", 59), rep("S", 59), rep("K", 60), rep("S", 60))),
      type = "state"
   ),
   data.frame(max2018 = no_SE_pred_cov, site = c(rep("K", 59), rep("S", 59), rep("K", 60), rep("S", 60)))
)

# scenario with just N Kaufman tree line removed
no_N_pred_cov <- raster::extract(horizon2018_No_N_max_cov, d.extract)

pred_no_N = data.frame(
   predict(
      p.ord.dtime_psi.max,
      newdata = data.frame(max2018 = no_N_pred_cov, site = c(rep("K", 59), rep("S", 59), rep("K", 60), rep("S", 60))),
      type = "state"
   ),
   data.frame(max2018 = no_N_pred_cov, site = c(rep("K", 59), rep("S", 59), rep("K", 60), rep("S", 60)))
)

# scenario with Skeet wires removed
no_wires_pred_cov <- raster::extract(horizon2018_No_wires_max_cov, d.extract)

pred_no_wires = data.frame(
   predict(
      p.ord.dtime_psi.max,
      newdata = data.frame(max2018 = no_wires_pred_cov, site = c(rep("K", 59), rep("S", 59), rep("K", 60), rep("S", 60))),
      type = "state"
   ),
   data.frame(max2018 = no_wires_pred_cov, site = c(rep("K", 59), rep("S", 59), rep("K", 60), rep("S", 60)))
)

cbind(
aggregate(pred_no_action$Predicted, list(pred_no_action$site), sum),
aggregate(pred_no_SW$Predicted, list(pred_no_SW$site), sum),
aggregate(pred_no_SE$Predicted, list(pred_no_SE$site), sum),
aggregate(pred_no_N$Predicted, list(pred_no_N$site), sum),
aggregate(pred_no_trees$Predicted, list(pred_no_trees$site), sum),
aggregate(pred_no_wires$Predicted, list(pred_no_wires$site), sum)
)

```
# From Kery book:
```{r}
# Finally, we estimate the area of occurrence of red squirrels in Switzerland in 2007. For this, we
# make the assumption that each MHB route samples exactly 1 km2, and, hence, we simply add up the
# occupancy probability for each quadrat.We do this both with and without the mask cutting out areas at
# elevation greater than 2250 m and see that our model predicts hardly any squirrels occurring at these
# very high elevations.
# Get extent of squirrel occurrence in 2007
sum(predCH$Predicted) # All quadrats
# [1] 17354.57
sum(predCH$Predicted[CH$elevation < 2250]) # Only at elevations < 2250 m
# [1] 17350.34
# We also want to assess the uncertainty around this estimate via the bootstrap. We do the prediction
# “by hand” rather than using the predict function because we don’t need the SEs and predict would
# take way too much time when used in a bootstrapped function.

# Standardise prediction covariate identical to those in analysis
pelev <- (CH$elevation - means[1]) / sds[1]
pforest <- (CH$forest - means[2]) / sds[2]
# Define function that predicts occupancy under model 20
Eocc <- function(fm) {
betavec <- coef(fm)[1:8] # Extract coefficients in psi

DM <- cbind(rep(1,length(pelev)), pelev, pelev^2, pforest, pforest^2, pelev*pforest,
pelev*pforest^2, pelev^2*pforest) # design matrix
pred <- plogis(DM%*%(betavec)) # Prediction = DM * param. vector
Eocc <- sum(pred) # Sum over all Swiss quadrats (no mask)
Eocc
}
(estimate.of.occurrence <- Eocc(fm20)) # Same as before, without mask
system.time(Eocc.boot <- parboot(fm20, Eocc, nsim=1000, report=10)) # 100 sec
plot(Eocc.boot) # Plot bootstrap distribution of extent of occurrence
quantile(Eocc.boot@t.star, c(0.025, 0.975))
# 2.5% 97.5%
# 15131.14 20185.21
# Convert these estimates to a proportion of the country
(c(point = 17354.57, quantile(Eocc.boot@t.star, c(0.025, 0.975))) / 42275
# point 2.5% 97.5%
# 0.4104161 0.3579217 0.4774740

```
